
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Chess Template</title>
  <link rel="stylesheet" href="css/chessboard.css" />
  <link rel="stylesheet" href="css/style.css" />
  <audio>
	<source src="sounds/move.mp3"></source>
	<source src="sounds/yahoo.mp3"></source>
  </audio>
</head>
<body>

<script src="js/chess.js"></script>
<div id="board"></div>
<div id="result"></div>
<div id="contestants"></div>

<script src="js/json3.min.js"></script>
<script src="js/jquery-1.10.1.min.js"></script>
<script src="js/chessboard.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.6.0/firebase.js"></script>
<script>

var config = {
    apiKey: "AIzaSyCHeQzV0MDQBGB26yxk9tR8xjp8R0HeNIc",
    authDomain: "chessgame-820fd.firebaseapp.com",
    databaseURL: "https://chessgame-820fd.firebaseio.com",
    projectId: "chessgame-820fd",
    storageBucket: "",
    messagingSenderId: "120194086270"
  };
firebase.initializeApp(config);

var findbyturn = (snapshot,turn)=>{
  let arr = Object.keys(snapshot.val());
  for(let i = 0 ; i<arr.length;i++){
    if(snapshot.val()[arr[i]].id==turn)
      return snapshot.val()[arr[i]].name;
  }
  return null;
}

var afkcounter=0;
function afkchecker(){
  if(turnid == myid&& myid!=0){
    afkcounter++;
    if(afkcounter>100){
      console.log("uhoh afk for 10 sec!! turnid is:",turnid);
      let tempid=turnid;
      
        if(player1name&&player2name){
          console.log("player1is",player1name,"player2nameis:",player2name);
          firebase.database().ref('message/').set({
            message:(myname==player1name?player2name:player1name)+' wins '+(myname==player1name?player1name:player2name)+' hasnt moved for 100 seconds.',
            winner:player2name,
            loser:player1name,
          }).then(()=>{
              firebase.database().ref('message/').set({});
          });
          console.log("i lost due to afk, setting turn to:",(tempid%2==1)?(tempid+2):(tempid+1),'my id is:',myid,'turnid is:',tempid);
          firebase.database().ref('turn/').set({
            turn:(tempid%2==1)?(tempid+2):(tempid+1),
            board:'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
          });
        }
        else{
          //erase me if i dont have an opponent yet. oh and reset the board.
          firebase.database().ref('message/').set({
              message:myname+' has been kicked for not moving for 100 seconds.',
              winner:"",
              loser:player1name,
          }).then(()=>{
              firebase.database().ref('message/').set({});
          });

          console.log("i lost and i have no opponent, setting turn to:",tempid);
          firebase.database().ref('users/'+myname).set({});   
          firebase.database().ref('turn/').set({
            turn:tempid,
            board:'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
          });
      }
      myid=0;
    }
    else{
      console.log("you have",100-afkcounter,"seconds left to complete your turn. turnid is:",turnid);
    }
  }
  else{
    afkcounter=0;
  }
  return afkcounter;
}

var player1name=null;
var player2name=null;

var onlineusers=1;
var myid=1;
var turnid=1;
var nextturn=2;
var nextboard='rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';
let myname=null;
var userarr=null;
var position = 'start'; 
// var position= '4Q3/6P1/2P2k2/P1P4P/3Q4/5N2/4K3/RNB2B1R b - - 3 27';
// var position='4Q3/6P1/2P5/P1P2k1P/3Q4/5N2/4K3/RNB2B1R w - - 4 28';

window.onbeforeunload = async function(){
  // alert("confirm exit is being called");
  console.log("b4 unlaod");
    // return "are ye sure bout dat?";
    if(myname==player1name || myname == player2name){
      console.log("myname==player1name || myname == player2name");
      let tempid=turnid;
      // if i leave, give the win to my opponent.
      if(player2name){
        console.log(" if(player2name){ ,player1 and player2 are:",player1name,player2name);
        firebase.database().ref('message/').set({
          message:(myname==player1name?player2name:player1name)+' wins '+(myname==player1name?player1name:player2name)+' has disconnected.',
          winner:player2name,
          loser:player1name,
        }).then(()=>{
          firebase.database().ref('message/').set({});
        });
        
        firebase.database().ref('turn/').set({
          turn:(tempid%2==1)?(tempid+2):(tempid+1),
          board:'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
        });
      }
      else{
        //erase me if i dont have an opponent yet. oh and reset the board.
        firebase.database().ref('users/'+myname).set({});   
        firebase.database().ref('turn/').set({
          turn:(tempid%2==1?tempid:tempid-1),
          board:'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
        });
      }
    }
    else if(myid>=turnid){
      console.log("else if(myid>=turnid){");
      firebase.database().ref('/users/').once('value').then(function(snapshot) {
        let names=Object.keys(snapshot.val());
        let res = snapshot.val();
        console.log("names",names);
        for(let i=0;i<names.length;i++){
          if(snapshot.val()[names[i]].id>myid){
            res[names[i]].id--;
          }
          if(snapshot.val()[names[i]].name==myname){
            console.log("same name!",names[i]);
            res[names[i]]=null;
            console.log(res[names[i]]);
          }
        }
        console.log("setting new snap:");
        console.log(res);
        firebase.database().ref('users/').set(res);   
      });   
      // firebase.database().ref('users/'+myname).set({});
    }
    if(onlineusers==1){
      firebase.database().ref('turn/').set({});
      firebase.database().ref('users/').set({});  
    }
      
    // console.log("@@@@"+player2name);
    // return 'waw';
}

var init = function() {

var board,
  game = new Chess(position === 'start' ? undefined : position);
// do not pick up pieces if the game is over
// only pick up pieces for the side to move
var onDragStart = function(source, piece, position, orientation) {
  console.log("name is:",myname,"myidis:",myid,"turnid is:",turnid);
  if (game.game_over() === true ||
      (game.turn() === 'w' && piece.search(/^b/) !== -1) ||
      (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
    return false;
  }
};

var onDrop = function(source, target) {
  // see if the move is legal
  if(turnid===myid){

    var move = game.move({
      from: source,
      to: target,
      promotion: 'q' // NOTE: always promote to a queen for example simplicity
    });
    
    // illegal move
    if (move === null) return 'snapback';
    
    updateStatus();
    firebase.database().ref('turn/').set({
        turn:nextturn,
        board:nextboard,
      });  
    $("audio")[0].play();
  }
};

// update the board position after the piece snap 
// for castling, en passant, pawn promotion
var onSnapEnd = function() {
  board.position(game.fen());
};

var updateStatus = function() {
  var status = '';

  var moveColor = 'White';
  if (game.turn() === 'b') {
    moveColor = 'Black';
  }

  // checkmate?
  if (game.in_checkmate() === true) {
    status = 'Game over, ' + (moveColor === 'White' ? 'Black' : 'White') + ' won.';
    firebase.database().ref('message/').set({
      message:"Game over, "+myname+" won.",
      winner:player1name,
      loser:player2name,
    }).then(()=>{
      firebase.database().ref('message/').set({});
    });
    nextturn = (turnid%2==1)?(turnid+2):(turnid+1);
    nextboard = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1'
    let audio = new Audio('sounds/yahoo.mp3') ;
    audio.play();
    
  }

  // draw?
  else if (game.in_draw() === true) {
    status = 'Game over, drawn position';
    console.log(" is ze draw, position is:",position);
    // position='start';
    // init();
    console.log("my id is:",myid,"turnid is:",turnid,"(turnid%2==1)?(turnid+2):(turnid+1) is:",(turnid%2==1)?(turnid+2):(turnid+1),"game.fen is:",game.fen());
    console.log("my id is:",myid,"turnid is:",turnid,"(turnid%2==1)?(turnid+2):(turnid+1) is:",(turnid%2==1)?(turnid+2):(turnid+1));
    firebase.database().ref('message/').set({
      message:status+"between "+player1name+" and "+player2name+".",
      winner:player1name,
      loser:player2name,
    }).then(()=>{
      firebase.database().ref('message/').set({});
    });
    nextturn = (turnid%2==1)?(turnid+2):(turnid+1);
    nextboard = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1'
    
    let audio = new Audio('sounds/yahoo.mp3') ;
    audio.play();
  }

  // game still on
  else {
    nextturn=(turnid%2==1)?(turnid+1):(turnid-1);
    nextboard=game.fen();
    status = moveColor + ' to move';

    // check?
    if (game.in_check() === true) {
      status += ', ' + moveColor + ' is in check';
    }
  }

  $("#result").html(status);
  console.log(game.fen());
  console.log(game.pgn());
};

var cfg = {
  draggable: true,
  position: position,
  onDragStart: onDragStart,
  onDrop: onDrop,
  onSnapEnd: onSnapEnd
};
board = ChessBoard('board', cfg);
updateStatus();

}; // end init()

setInterval(afkchecker, 1000);  
//whenever turn changes on thefirebase, this triggers.
var Ref = firebase.database().ref('turn/');
Ref.on("value",async function(snapshot) {
  await firebase.database().ref('/users/').once('value').then(function(snapshot) {
    userarr=snapshot;
  });
  if(snapshot.val()!=null && userarr !=null){
    console.log("turn changed.");
    // userarr=Object.keys(snapshot.val());
    console.log('IN TURN,its :',snapshot.val().turn,'s turn');
    turnid=snapshot.val().turn;
    position=snapshot.val().board;
    console.log('Object.keys(snapshot.val())',Object.keys(snapshot.val()));
    console.log("userarr is:",userarr);
    if(turnid>=2){
      if(turnid%2==1){
        player1name=findbyturn(userarr,turnid);
        player2name=findbyturn(userarr,turnid+1);
        console.log("player11name is now:",(userarr[turnid-1]===undefined)?null:userarr[turnid-1],"player2nmae is now:",(userarr[turnid]===undefined)?null:userarr[turnid]);
      }
      else{
        player1name=findbyturn(userarr,turnid-1);;
        player2name=findbyturn(userarr,turnid);;
        console.log("player1name is now:",(userarr[turnid-2]===undefined)?null:userarr[turnid-2],"player 2name is now:",(userarr[turnid-1]===undefined)?null:userarr[turnid-1]);
      }
      // $("#contestants").html("<b id='player1'>"+(player1name==null?'white(unconnected)':player1name)+"</b>"+" VS "+ "<b>"+(player2name==null?'black(unconnected)':player2name)+"</b>");
      $("#contestants").html("<b id='player1'>"+(player1name==null?'white(unconnected)':player1name)+"</b>"+" <div id='fire'>VS</div> "+ "<b>"+(player2name==null?'black(unconnected)':player2name)+"</b>");
}

    // console.log("usearr is:",userarr,"userarr[11] is:",userarr[11]);  
    // $("#contestants").html("<b id='player1'>"+player1name+"</b>"+" VS "+ "<b>"+player2name+"</b>");
    // $("#contestants").html("<b id='player1'>"+(player1name==null?'white(unconnected)':player1name)+"</b>"+" <div id='fire'>VS</div> "+ "<b>"+(player2name==null?'black(unconnected)':player2name)+"</b>");
    init();
    console.log("finished init, turnid is",turnid);
    // board.position(snapshot.val().board);
    // updateStatus();
    // console.log("new board is:",snapshot.val().board);
    // console.log("my name is:",name,'my is:',myid,'turnid is:',turnid);
  }
});

var Ref2 = firebase.database().ref('users/');
//whenever the users change on firebase, this triggers

Ref2.on("value", function(snapshot) {
  if(snapshot.val()!=null){
    console.log("in Ref2.on, user changed.");
    userarr=(snapshot);
    if(snapshot.val()[myname]){
      myid=snapshot.val()[myname].id;
    }
    // myid=;
    console.log("@@@@");
    console.log(snapshot.val()[myname]);
    console.log('Object.keys(snapshot.val())',Object.keys(snapshot.val()));
    // console.log("what is:",snapshot.val()[Object.keys(snapshot.val())[0]]);
    player1name=findbyturn(snapshot,turnid);
    console.log("turn is:",turnid,"and its' player is:",player1name);  
    console.log("turn is:",turnid,"and its' player is:",player1name);
    console.log("turn is:",turnid,"and its' player is:",player1name);
    if(turnid%2==1){
        player1name=(findbyturn(snapshot,turnid));
        player2name=findbyturn(snapshot,turnid+1);
        console.log("player11name is now:",(userarr[turnid-1]===undefined)?null:userarr[turnid-1],"player2nmae is now:",(userarr[turnid]===undefined)?null:userarr[turnid]);
      }
      else{
        player1name=findbyturn(snapshot,turnid-1);
        player2name=findbyturn(snapshot,turnid);
        console.log("player1name is now:",(userarr[turnid-2]===undefined)?null:userarr[turnid-2],"player 2name is now:",(userarr[turnid-1]===undefined)?null:userarr[turnid-1]);
    }
    // console.log("usearr is:",userarr,"userarr[11] is:",userarr[11]);  
    // $("#contestants").html("<b id='player1'>"+player1name+"</b>"+" VS "+ "<b>"+player2name+"</b>");
    $("#contestants").html("<b id='player1'>"+(player1name==null?'white(unconnected)':player1name)+"</b>"+" <div id='fire'>VS</div> "+ "<b>"+(player2name==null?'black(unconnected)':player2name)+"</b>");

    init();
  }
});
var Ref3 = firebase.database().ref('message/');
Ref3.on("value", function(snapshot) {
  if(snapshot.val()!=null){
    alert(snapshot.val().message);
    if(snapshot.val().message.winner==myname ||snapshot.val().loser == myname){
      turnid=0;
    }
    firebase.database().ref('message/').set({});
  }
});
firebase.database().ref('/users/').once('value').then(function(snapshot) {
  // var childData = snapshot.val();
  // var key = Object.keys(childData)[0];    //this will return 1st key.         
  // console.log(childData[key].id);
  // console.log("select a name",snapshot.val());
  // myid=snapshot.val(); 
  let usednames = (snapshot.val()!=null)?Object.keys(snapshot.val()):[];
  let message="enter a name";
  
  do{
    // console.log( Object.keys(snapshot.val()));
    myname = prompt(message);
    if(usednames.includes(myname)){
      message="please select a different name";
      myname=null;
    }
  }while(myname==null||myname=='');
  console.log("my chosen name is:",myname);

  if(snapshot.val()==null){
    myid=1;
    turnid=1;
    console.log("my name is:",myname,'my is:',myid,'turnid is:',turnid);
    firebase.database().ref('users/' + myname).set({
      name: myname,
      id:1,
      });
  }
  else if(Object.keys(snapshot.val()).length==1){
    myid=2;
    console.log("my name is:",myname,'my is:',myid,'turnid is:',turnid);
    firebase.database().ref('users/' + myname).set({
      name: myname,
      id:2,
    });
  }
  else{ 
    myid=Object.keys(snapshot.val()).length+1;
    console.log("my name is:",myname,'my is:',myid,'turnid is:',turnid);
    firebase.database().ref('users/' + myname).set({
      name: myname,
      id:Object.keys(snapshot.val()).length+1,
    });
  }
  if(snapshot.val()!=null)
    console.log("there are:",Object.keys(snapshot.val()).length,'users');   
});
var listRef = firebase.database().ref('presence/');
var userRef = listRef.push();

// Add ourselves to presence list when online.
var presenceRef = firebase.database().ref('.info/connected');
presenceRef.on("value", function(snap) {
  if (snap.val()) {
    // Remove ourselves when we disconnect.
    userRef.onDisconnect().remove();

    userRef.set(true);
  }
});

// Number of online users is the number of objects in the presence list.
listRef.on("value", function(snap) {
  console.log("# of online users = " + snap.numChildren());
  onlineusers=snap.numChildren();
});    
$(document).ready(init);

//position = 'rnbqkbnr/ppp2ppp/3p4/4p3/3PP3/8/PPP2PPP/RNBQKBNR w KQkq - 0 3';
//init();

</script>
</body>
</html>